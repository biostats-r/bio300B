---
title: "Survival analysis and Summary"
subtitle: "Bio300B Lecture 11"
author: "Richard J. Telford (Richard.Telford@uib.no)"
institute: "Institutt for biovitenskap, UiB"
date: today
date-format: "D MMMM YYYY"
format: 
  revealjs:
    theme: [default, css/custom.scss]
    chalkboard: true
execute: 
  echo: true
  warning: false
  error: true
---


## Survival analysis


```{r setup, echo=FALSE, message=FALSE}
library("tidyverse")
library("patchwork")
library(broom)
library(glue)
library(ggbeeswarm)
library(lme4)
library(patchwork)
theme_set(theme_bw(base_size = 18))
data(penguins, package = "palmerpenguins")
#options(dplyr.print_min = 2, dplyr.print_max = 3, digits = 4)
```

How long (or far) until an event happens

- How long before a seed germinates
- How long before a patient dies after diagnosis
- How many jumps can a horse clear at a racecourse

Data are typically right censored.

`survival` package


## Survival data

Response data 

- time
- status (0/1, 1/2 TRUE/FALSE)

```{r data}
library(survival)
data(lung)
lung |> slice(1:10)
```


## Survival response

+ indicates censored data

```{r, eval = FALSE}
Surv(lung$time, lung$status)
```

```{r, echo = FALSE}
Surv(lung$time, lung$status)[1:30]
```


## Fitting a model


```{r}

lung <- lung |> 
  mutate(sex = factor(sex, levels = 1:2, labels = c("male", "female")))

mod_surv <- survfit(Surv(time, status) ~ sex, data = lung)

mod_surv
```


## plotting a model

- Kaplan-Meier curve
- '+' mark censored data

```{r survival-plot, fig.height = 5}
library(ggfortify)
autoplot(mod_surv)
```


## Testing differences in survival time

 - between two or more groups

```{r}
mod_diff <- survdiff(Surv(time, status) ~ sex, data = lung)
mod_diff
```


## Survivorship curve

Shape of the survival curve


```{r survivorship-curves, echo = FALSE, out.height="60%"}
knitr::include_graphics("figures/Survivorship_Curves.jpg")
```




## Hazard: The instantaneous risk of death

```{r}
m_ll <- survreg(Surv(time, status) ~ age + sex, 
                data = lung,
                dist = "loglogistic")
summary(m_ll)
```

Choice of distribution

---

Exponentiated coefficients show relative increase or decrease in the expected survival times when a covariate is increased one step while others are fixed:

```{r}

exp(coef(m_ll))
```

Expected survival time decreases by 1.4 % (i.e. multiply by 0.986) for each additional year of age

The expected survival time for females is 61.2 % higher than for males (multiply by 1.612).


---

scale 

```{r}
m_ll$scale
```


The scale parameter < 1, indicates that slope of the
hazard decreases with time -  Type III

## Choice of distribution

```{r}
#| echo: false
read_delim("Distribution, df
exponential, 1 
Weibull, 2 
lognormal, 2 
log logistic, 2 ") |> 
  gt::gt() |> 
  gt::tab_options(table.font.size = 20)
```

```{r}
#| label: distr
#| echo: false
#| eval: false

x = seq(0, 2.5, length = 100)
c(0.5, 1, 1.5, 5) |> 
  set_names() |> 
  map(~dweibull(x, shape = 1, scale = .x)) |> 
  map(enframe) |> 
  map(bind_cols, x = x) |> 
  list_rbind(names_to = "scale") |> 
  ggplot(aes(x = x, y = value, colour = scale )) +
  geom_line()
        
```


Can use AIC to choose best

```{r}
m_w <- update(m_ll, dist = "weibull")
AIC(m_ll, m_w)
```


## Summary

## Most important things

1. Designing an experiment
1. R tips and tricks
1. Entering data into a spreadsheet
1. Importing data
1. Cleaning data
1. Data visualisation
1. Using quarto
1. Choosing a model type
1. Interpreting model output







## Method choice - 2 key questions

Are the data clustered/grouped?

What is the distribution of the residuals?

(also other types of model - survival etc)


## Clustered data

Mixed effect models

- Normal distribution:  linear mixed effect models
- Binomial/poisson: generalised linear mixed effect models


## Independent data, normal distribution

Linear models - ordinary least squares

- t-tests
 - two sample t-test
 - one sample t-test
 - paired t-test
- lm





## Independent data, non-normal distribution

generalised linear models 

- glm

Binomial & Poisson distributions


## Interpreting model output


```{r}
data(penguins, package = "palmerpenguins")
mod <- lm(bill_length_mm ~ sex * species, data = penguins)
summary(mod)
```


## More statistics at BIO

### Bio302 Spring semester

- more regression methods
- more R
- GitHub

### Bio303 

- multivariate methods
  - ordinations
  - cluster analysis


